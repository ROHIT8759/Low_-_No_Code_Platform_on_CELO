generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  wallet_address String   @unique
  email          String?
  username       String?
  created_at     DateTime @default(now()) @db.Timestamptz()
  updated_at     DateTime @default(now()) @updatedAt @db.Timestamptz()

  projects           Project[]
  deployed_contracts DeployedContract[]

  @@index([wallet_address], name: "idx_users_wallet_address")
  @@map("users")
}

model Project {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id          String   @db.Uuid
  name             String
  description      String?
  blocks           Json     @default("[]")
  contract_type    String
  contract_config  Json?
  solidity_code    String?
  frontend_code    String?
  contract_id      String?  @db.Uuid
  network          String?  @db.VarChar(50)
  frontend_version String?  @db.VarChar(20)
  created_at       DateTime @default(now()) @db.Timestamptz()
  updated_at       DateTime @default(now()) @updatedAt @db.Timestamptz()

  user               User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  contract           Contract?          @relation(fields: [contract_id], references: [id], onDelete: SetNull)
  deployed_contracts DeployedContract[]
  analytics          Analytics[]

  @@index([user_id], name: "idx_projects_user_id")
  @@index([updated_at(sort: Desc)], name: "idx_projects_updated_at")
  @@index([contract_id], name: "idx_projects_contract_id")
  @@map("projects")
}

model DeployedContract {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id          String   @db.Uuid
  project_id       String?  @db.Uuid
  contract_address String
  contract_name    String
  token_name       String?
  token_symbol     String?
  network          String
  network_name     String
  chain_id         Int
  deployer         String
  deployed_at      DateTime @db.Timestamptz()
  transaction_hash String
  contract_type    String
  abi              Json
  solidity_code    String
  blocks           Json     @default("[]")
  explorer_url     String
  frontend_url     String?
  github_repo      String?
  created_at       DateTime @default(now()) @db.Timestamptz()

  user    User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [project_id], references: [id], onDelete: SetNull)

  @@index([user_id], name: "idx_deployed_contracts_user_id")
  @@index([contract_address], name: "idx_deployed_contracts_contract_address")
  @@index([deployed_at(sort: Desc)], name: "idx_deployed_contracts_deployed_at")
  @@map("deployed_contracts")
}

model Contract {
  id               String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  network          String   @db.VarChar(50)
  contract_type    String   @db.VarChar(20)
  abi              Json
  bytecode_hash    String?  @db.VarChar(64)
  wasm_hash        String?  @db.VarChar(64)
  artifact_id      String   @unique @db.VarChar(64)
  deployer         String   @db.VarChar(100)
  contract_address String?  @db.VarChar(100)
  tx_hash          String   @db.VarChar(100)
  created_at       DateTime @default(now()) @db.Timestamptz()

  projects Project[]

  @@index([deployer], name: "idx_contracts_deployer")
  @@index([network], name: "idx_contracts_network")
  @@index([tx_hash], name: "idx_contracts_tx_hash")
  @@index([artifact_id], name: "idx_contracts_artifact_id")
  @@map("contracts")
}

model Analytics {
  id                String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  project_id        String?  @db.Uuid
  gas_spent         BigInt   @default(0)
  tx_count          Int      @default(0)
  user_interactions Int      @default(0)
  timestamp         DateTime @default(now()) @db.Timestamptz()

  project Project? @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id], name: "idx_analytics_project_id")
  @@index([timestamp], name: "idx_analytics_timestamp")
  @@map("analytics")
}

model CompilationJob {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  job_id           String    @unique @db.VarChar(100)
  contract_type    String    @db.VarChar(20)
  status           String    @db.VarChar(20)
  source_code_hash String    @db.VarChar(64)
  artifact_id      String?   @db.VarChar(64)
  error_message    String?
  created_at       DateTime  @default(now()) @db.Timestamptz()
  completed_at     DateTime? @db.Timestamptz()

  @@index([job_id], name: "idx_compilation_jobs_job_id")
  @@index([status], name: "idx_compilation_jobs_status")
  @@map("compilation_jobs")
}
